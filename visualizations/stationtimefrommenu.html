<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Choose Station and Time</title>
        <script type="text/javascript" src="d3.js"></script>
		
		<style type="text/css">
		.axis path,
		.axis line {fill:none;stroke:black; shape-rendering:crispEdges;}
		</style>
    </head>
    <body>
		Test visualizations for the remote monitoring system.
		<br>
        <script type="text/javascript">

		var w = 500;
		var h = 200;
		var buffer_x = 60;
		var buffer_y = 30;

		var pathname;
		var stationToCSV = {"dummy":0,"Station 1":"fakedata.csv", "Station 2":"morefakedata.csv"};
		var stationmenu = d3.select("body").append("select").attr("class","select").attr("id","stationmenu")
							.on("change",getpath);
		
		stationmenu.append("option").text("Select a station")
								.attr({
									selected:"selected",
									disabled:"disabled"
								});
		
		var stationoptions = stationmenu.selectAll("option").data(d3.keys(stationToCSV)).enter()
						.append("option").text(function(d) {return d;});

		var startTime, endTime, now = new Date();						
		var startTimes = {"dummy":0,
							"Lifetime" : 0,
							"All Time" : 0,
							"Today" : d3.time.day(now),
							"This Week" : d3.time.week(now),
							"This Month" : d3.time.month(now),
							"This Year" : d3.time.year(now)};
							
		var timemenu = d3.select("body").append("select").attr("class","select").attr("id","timemenu")
						.on("change",changescale);

		timemenu.append("option").text("Select a time range")
								.attr({
									selected:"selected",
									disabled:"disabled"
								});
		
		var timeoptions = timemenu.selectAll("option").data(d3.keys(startTimes)).enter()
						.append("option").text(function(d) {return d;});
						
		var customTimeFormat = d3.time.format.multi([
		  ["%H00", function(d) { return d.getHours(); }],
		  ["%m/%d", function(d) { return d.getMonth() && d.getDate() != 1; }],
		  ["%Y", function() { return true; }]
		]);
						
		var svg1, svg2, svg3, svg4, svg5, svg6, svg7, svg8, svg9, svg10, svg11, svg12;
		var graphs = [svg1, svg2, svg3,svg4,svg5,svg6,svg7,svg8,svg9,svg10,svg11,svg12];
			
		var names = ["Voltage 1","Current 1","Period 1","Delay 1",
					"Voltage 2","Current 2","Period 2","Delay 2",
					"Voltage 3","Current 3","Period 3","Delay 3"];		
			
		for(i=0;i<names.length;i++){
			if(i%4==0){
				d3.select("body").append("h2").text("Phase "+(i/4+1));
			}
			d3.select("body").append("p").text(names[i]);
			graphs[i] = d3.select("body").append("svg").attr("width",w).attr("height",h);
		}		
			
		
		function getpath(){
			selectValue = d3.select("select").property("value")
			pathname = stationToCSV[selectValue];
			console.log(pathname);
		};
		
		function changescale(){
			selectValue = d3.select("select#timemenu").property("value");
			startTime = startTimes[selectValue];
			console.log(startTime);
			console.log(now);
			
			var pathtocsv = pathname;
			console.log(pathtocsv);
			
			var dataset;
			var parseTime = d3.time.format("%Y%m%d_%H%M%S").parse;
			//TODO parse period and delay to get frequency, power factor?
						
			d3.text(pathname, "text/csv", function(text){
				dataset = d3.csv.parseRows(text, function(text){
					return [parseTime(text[0]),+text[1],+text[2],+text[3],+text[4],
												+text[5],+text[6],+text[7],+text[8],
												+text[9],+text[10],+text[11],+text[12]];
				});
				console.log(dataset);
				minTime = d3.min(dataset,function(d){return d[0];});
				if(startTime < minTime){
					startTime = minTime;
					console.log("Warning: time scale chosen predates logs, earliest log chosen for greater readability")
				};
				if(selectValue=="Lifetime"){
					endTime = d3.max(dataset, function(d) {return d[0];});
				}
				else {
					endTime = now;
				}

				if(startTime > endTime){
					console.log("Error: no logs in time range selected.");
				}
				else {
					console.log("good to go");
					var scaleX = d3.time.scale()
									.domain([startTime,endTime]).nice()
									.range([buffer_x,w - buffer_x]);
					var xAxis = d3.svg.axis().scale(scaleX).orient("bottom")
										.ticks(5)
										.tickFormat(customTimeFormat);				
				};
				
				for(i=0;i<names.length;i++){

					var scaleY = d3.scale.linear().domain([0,1.2*d3.max(dataset, function(d) {return d[i+1];})])
									.range([h - buffer_y, buffer_y]);
					
					var yAxis = d3.svg.axis().scale(scaleY).orient("left").ticks(5);

					graphs[i].selectAll("*").remove();
					graphs[i].selectAll("circle").data(dataset).enter().append("circle")
							.attr("cx", function(d){return scaleX(d[0]);}) 
							.attr("cy", function(d){return scaleY(d[i+1]);})
							.attr("r",5);					
					graphs[i].selectAll("text").data(dataset).enter().append("text")
							.text(function(d) {return d[i+1];})
							.attr("x", function(d) {return scaleX(d[0]);}).attr("y",function(d){return scaleY(d[i+1])-5;});
					graphs[i].append("g").attr("class","axis")
							.attr("transform","translate(0," + (h - buffer_y) +")").call(xAxis);
					graphs[i].append("g").attr("class","axis")
							.attr("transform","translate(" + buffer_x + ",0)").call(yAxis);
				}				
			});
		};

		</script>
    </body>
</html>     